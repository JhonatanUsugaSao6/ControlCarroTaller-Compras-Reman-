{% include "inc/header.html" %}

<div class="container letra-insertar" style="flex: 1;">
    <h1 class="titulo-insertar mt-5">Agregar nuevo registro</h1>
    <div class="formulario">
        <div id="errorCedula" class="text-danger"></div>
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="row">

                <div class="col-sm-12 col-lg-4 margen">
                    <div class="form-floating">
                        <input type="number" name="cedula_conductor"
                            class="form-control borde-input {% if form.errors.cedula_conductor %}is-invalid{% endif %}"
                            id="floatingInputCedulaConductor" placeholder="Cédula del conductor"
                            value="{{ request.POST.cedula_conductor|default:'' }}">
                        <label for="floatingInputCedulaConductor">Cédula del Conductor</label>
                
                        {% if form.cedula_conductor.errors %}
                        <div class="text-danger">   
                            {% for error in form.cedula_conductor.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-sm-12 col-lg-4 margen">
                    <div class="form-floating">
                        <input type="text" name="nombre_conductor"
                            class="form-control borde-input {% if form.errors.nombre_conductor %}is-invalid{% endif %}"
                            id="floatingInputNombreConductor" placeholder="Nombre del conductor"
                            value="{{ request.POST.nombre_conductor|default:'' }}" readonly>
                        <label for="floatingInputNombreConductor">Nombre del Conductor</label>
                        {% if form.nombre_conductor.errors %}
                        <div class="text-danger">
                            {% for error in form.nombre_conductor.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-sm-12 col-lg-4 margen">
                    <div class="form-floating">
                        <input type="text" name="cargo_conductor"
                            class="form-control borde-input {% if form.errors.cargo_conductor %}is-invalid{% endif %}"
                            id="floatingInputCargoConductor" placeholder="Cargo del conductor"
                            value="{{ request.POST.cargo_conductor|default:'' }}" readonly>
                        <label for="floatingInputCargoConductor">Cargo del Conductor</label>
                        {% if form.cargo_conductor.errors %}
                        <div class="text-danger">
                            {% for error in form.cargo_conductor.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>


                <div class="col-sm-12 col-lg-4 margen">
                    <div class="form-floating">
                        <input type="number" name="cedula_acompanante"
                            class="form-control borde-input {% if form.errors.cedula_acompanante %}is-invalid{% endif %}"
                            id="floatingInputCedulaAcompanante" placeholder="Cédula del acompañante"
                            value="{{ request.POST.cedula_acompanante|default:'' }}">
                        <label for="floatingInputCedulaAcompanante<">Cédula del acompañante</label>
                        {% if form.cedula_acompanante.errors %}
                        <div class="text-danger">
                            {% for error in form.cedula_acompanante.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-sm-12 col-lg-4 margen">
                    <div class="form-floating">
                        <input type="text" name="nombre_acompanante"
                            class="form-control borde-input {% if form.errors.nombre_acompanante %}is-invalid{% endif %}"
                            id="floatingInputNombreAcompanante" placeholder="Nombre del acompañante"
                            value="{{ request.POST.nombre_acompanante|default:'' }}" readonly>
                        <label for="floatingInputNombreAcompanante">Nombre del acompañante</label>
                        {% if form.nombre_acompanante.errors %}
                        <div class="text-danger">
                            {% for error in form.nombre_acompanante.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-sm-12 col-lg-4 margen">
                    <div class="form-floating">
                        <input type="text" name="cargo_acompanante"
                            class="form-control borde-input {% if form.errors.cargo_acompanante %}is-invalid{% endif %}"
                            id="floatingInputCargoAcompanante" placeholder="Cargo del acompañante"
                            value="{{ request.POST.cargo_acompanante|default:'' }}" readonly>
                        <label for="floatingInputCargoAcompanante">Cargo del acompañante</label>
                        {% if form.cargo_acompanante.errors %}
                        <div class="text-danger">
                            {% for error in form.cargo_acompanante.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-sm-12 col-lg-4 margen">
                    <div class="form-floating">
                        <input type="date" name="fecha"
                            class="form-control borde-input fecha {% if form.errors.fecha %}is-invalid{% endif %}"
                            id="floatingInputFecha" placeholder="Fecha" value="{{ request.POST.fecha|default:'' }}">
                        <label for="floatingInputFecha">Fecha</label>
                        {% if form.fecha.errors %}
                        <div class="text-danger">
                            {% for error in form.fecha.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-sm-12 col-lg-4 margen">
                    <div class="form-floating">
                        <input type="time" name="hora_salida"
                            class="form-control borde-input hora {% if form.errors.hora_salida %}is-invalid{% endif %}"
                            id="floatingInputHoraSalida" placeholder="Hora de salida"
                            value="{{ request.POST.hora_salida|default:'' }}">
                        <label for="floatingInputHoraSalida">Hora de salida</label>
                        {% if form.hora_salida.errors %}
                        <div class="text-danger">
                            {% for error in form.hora_salida.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-sm-12 col-lg-4 margen">
                    <div class="form-floating">
                        <input type="time" name="hora_entrada"
                            class="form-control borde-input {% if form.errors.hora_entrada %}is-invalid{% endif %}"
                            id="floatingInputHoraEntrada" placeholder="Hora de entrada"
                            value="{{ request.POST.hora_entrada|default:'' }}" disabled>
                        <label for="floatingInputHoraEntrada">Hora de entrada</label>
                        {% if form.hora_entrada.errors %}
                        <div class="text-danger">
                            {% for error in form.hora_entrada.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-sm-12 col-lg-6 margen">
                    <div class="form-floating">
                        <input type="text" name="kilometraje_salida"
                            class="form-control borde-input {% if form.errors.kilometraje_salida %}is-invalid{% endif %}"
                            id="floatingInputKilometrajeSalida" placeholder="Kilometraje de Salida"
                            value="{{ request.POST.kilometraje_salida|default:'' }}">
                        <label for="floatingInputKilometrajeSalida">Kilometraje de Salida</label>
                        {% if form.kilometraje_salida.errors %}
                        <div class="text-danger">
                            {% for error in form.kilometraje_salida.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-sm-12 col-lg-6 margen">
                    <div class="form-floating">
                        <input type="number" name="kilometraje_entrada"
                            class="form-control borde-input {% if form.errors.kilometraje_entrada %}is-invalid{% endif %}"
                            id="floatingInputKilometrajeEntrada" placeholder="Kilometraje de entrada"
                            value="{{ request.POST.kilometraje_entrada|default:'' }}" disabled>
                        <label for="floatingInputKilometrajeEntrada">Kilometraje de Entrada</label>
                        {% if form.kilometraje_entrada.errors %}
                        <div class="text-danger">
                            {% for error in form.kilometraje_entrada.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-sm-12 col-lg-6 margen">
                    <div class="form-floating">
                        <select name="motivo_salida"
                            class="form-select borde-input {% if form.errors.motivo_salida %}is-invalid{% endif %}"
                            id="floatingSelectMotivo" onchange="handleMotivoSalida(this)">
                            <option value="" disabled {% if not request.POST.motivo_salida %}selected{% endif %}>
                                Seleccione un motivo
                            </option>
                            <option value="Compra de repuestos" {% if request.POST.motivo_salida == "Compra de repuestos" %}selected{% endif %}>
                                Compra de repuestos
                            </option>
                            <option value="Salida por parte operaciones" {% if request.POST.motivo_salida == "Salida por parte operaciones" %}selected{% endif %}>
                                Salida por parte operaciones
                            </option>
                            <option value="Otro" {% if request.POST.motivo_salida == "Otro" or request.POST.motivo_salida_otro %}selected{% endif %}>
                                Otro
                            </option>
                            
                        </select>
                        <label for="floatingSelectMotivo">Motivo de salida</label>

                        <!-- Campo oculto para "Otro" -->
                        <input type="text" name="motivo_salida_otro"
                        class="form-control borde-input mt-2 {% if form.errors.motivo_salida %}is-invalid{% endif %}"
                        id="floatingMotivoOtro" placeholder="Especifique el motivo"
                        value="{{ request.POST.motivo_salida_otro }}"
                        {% if request.POST.motivo_salida == 'Otro' or request.POST.motivo_salida_otro %} 
                            style="display: block;" 
                        {% else %} 
                            style="display: none;" 
                        {% endif %}>
                        <label for="floatingInputHoraEntrada">Especifique el motivo</label>
                        {% if form.errors.motivo_salida %}
                        <div class="invalid-feedback">
                            {{ form.errors.motivo_salida|first }}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-sm-12 col-lg-6 margen">
                    <div class="form-floating">
                        <select name="autorizacion"
                            class="form-select borde-input {% if form.errors.autorizacion %}is-invalid{% endif %}"
                            id="floatingSelectAutorizacion">

                            <option value="" disabled {% if not request.POST.autorizacion %}selected{% endif %}>
                                Seleccione una autorización
                            </option>
                            <option value="Martín Hernandez" {% if request.POST.autorizacion == "Martín Hernandez" %}selected{% endif %}>
                                Martín Hernandez
                            </option>
                            <option value="Diego Ramirez" {% if request.POST.autorizacion == "Diego Ramirez" %}selected{% endif %}>
                                Diego Ramirez
                            </option>
                            <option value="Zamir Caro" {% if request.POST.autorizacion == "Zamir Caro" %}selected{% endif %}>
                                Zamir Caro
                            </option>
                            <option value="Ricardo Montoya" {% if request.POST.autorizacion == "Ricardo Montoya" %}selected{% endif %}>
                                Ricardo Montoya
                            </option>
                            <option value="Enrique Gomez" {% if request.POST.autorizacion == "Enrique Gomez" %}selected{% endif %}>
                                Enrique Gomez
                            </option>
                            <option value="Natalia Ospina" {% if request.POST.autorizacion == "Natalia Ospina" %}selected{% endif %}>
                                Natalia Ospina
                            </option>
                            <option value="Arnaldo Rodríguez" {% if request.POST.autorizacion == "Arnaldo Rodríguez" %}selected{% endif %}>
                                Arnaldo Rodríguez
                            </option>

                        </select>
                        <label for="floatingSelectAutorizacion">Autorización de salida</label>

                        {% if form.errors.autorizacion %}
                        <div class="invalid-feedback">
                            {{ form.errors.autorizacion|first }}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-sm-12 col-lg-12 margen">
                    <div class="form-floating">
                        <input type="text" name="observaciones"
                            class="form-control borde-input {% if form.errors.observaciones %}is-invalid{% endif %}"
                            id="floatingInputObservaciones" placeholder="Observaciones"
                            value="{{ request.POST.observaciones|default:'' }}">
                        <label for="floatingInputObservaciones">Observaciones</label>
                        {% if form.observaciones.errors %}
                        <div class="text-danger">
                            {% for error in form.observaciones.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-sm-12 col-md-12 col-lg-12 mb-3">
                    <label for="imagenes" class="form-label titulo">Adjuntar Imágenes:</label>
                    <div class="row">
                        <div class="col-md-6 text-center">
                            <div class="image-upload-box" onclick="document.getElementById('imagen1').click()">
                                <input type="file" id="imagen1" name="imagenes" accept="image/*" hidden onchange="previewFile(this, 'preview1', 'remove1')">
                                <img id="preview1" class="img-fluid" alt="Imagen 1">
                                <span class="add-icon">+</span>
                            </div>
                            <button id="remove1" type="button" class="btn btn-danger btn-sm mt-2" style="display: none; background-color: rgb(179, 26, 26);"" onclick="removeImage(event, 'imagen1', 'preview1', 'remove1')">Quitar</button>
                        </div>
                        <div class="col-md-6 text-center">
                            <div class="image-upload-box" onclick="document.getElementById('imagen2').click()">
                                <input type="file" id="imagen2" name="imagenes" accept="image/*" hidden onchange="previewFile(this, 'preview2', 'remove2')">
                                <img id="preview2" class="img-fluid" alt="Imagen 2">
                                <span class="add-icon">+</span>
                            </div>
                            <button id="remove2" type="button" class="btn btn-danger btn-sm mt-2" style="display: none; background-color: rgb(179, 26, 26);"" onclick="removeImage(event, 'imagen2', 'preview2', 'remove2')">Quitar</button>
                        </div>
                        <div class="col-md-6 text-center">
                            <div class="image-upload-box" onclick="document.getElementById('imagen3').click()">
                                <input type="file" id="imagen3" name="imagenes" accept="image/*" hidden onchange="previewFile(this, 'preview3', 'remove3')">
                                <img id="preview3" class="img-fluid" alt="Imagen 3">
                                <span class="add-icon">+</span>
                            </div>
                            <button id="remove3" type="button" class="btn btn-danger btn-sm mt-2" style="display: none; background-color: rgb(179, 26, 26);" onclick="removeImage(event, 'imagen3', 'preview3', 'remove3')">Quitar</button>
                        </div>
                        <div class="col-md-6 text-center">
                            <div class="image-upload-box" onclick="document.getElementById('imagen4').click()">
                                <input type="file" id="imagen4" name="imagenes" accept="image/*" hidden onchange="previewFile(this, 'preview4', 'remove4')">
                                <img id="preview4" class="img-fluid" alt="Imagen 4">
                                <span class="add-icon">+</span>
                            </div>
                            <button id="remove4" type="button" class="btn btn-danger btn-sm mt-2" style="display: none; background-color: rgb(179, 26, 26);" onclick="removeImage(event, 'imagen4', 'preview4', 'remove4')">Quitar</button>
                        </div>
                    </div>
                </div>
                
            </div>
            <button type="submit" class="btn btn-light boton-guardar">Guardar Registro</button>
        </form>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const fechaInputs = document.getElementsByClassName('fecha');
        const fechaActual = new Date().toISOString().split('T')[0];  // Formato YYYY-MM-DD

        for (let fechaInput of fechaInputs) {
            fechaInput.value = fechaActual;
            fechaInput.setAttribute('readonly', true); // Hacer que el campo sea solo lectura
        }


        const horaInputs = document.getElementsByClassName('hora');
        const horaActual = new Date().toTimeString().split(' ')[0].slice(0, 5);  // Formato HH:MM
        for (let horaInput of horaInputs) {
            horaInput.value = horaActual;  // Establece la hora actual
            horaInput.setAttribute('readonly', true); // Hacer que el campo de hora sea solo lectura
        }
    });

    function handleMotivoSalida(selectElement) {
        // Obtener el input de motivo_salida_otro
        const otroField = document.getElementById("floatingMotivoOtro");

        // Mostrar el campo de texto si la opción es "Otro"
        if (selectElement.value === "Otro") {
            otroField.style.display = "block";
            otroField.required = true; // Hacer el campo obligatorio
            otroField.value = ""; // Limpiar el valor si cambia
        } else {
            otroField.style.display = "none";
            otroField.required = false; // No obligatorio en otras opciones
            otroField.value = ""; // Limpiar el valor
        }
    }

    function getCSRFToken() {
        let name = 'csrftoken';
        let cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            let cookie = cookies[i].trim();
            if (cookie.startsWith(name + '=')) {
                return decodeURIComponent(cookie.substring(name.length + 1));
            }
        }
        return null;
    }
    
    document.getElementById('floatingInputCedulaConductor').addEventListener('blur', function () {
        const cedula = this.value.trim(); // Obtener el valor del input y limpiarlo
        
        if (cedula) {
            fetch('/registros/buscarConductor?cedula_conductor=' + cedula, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                credentials: 'same-origin' // Importante si estás usando Django y sesiones
            })
            .then(response => {
                if (!response.ok) {
                    // Manejar respuestas que no son exitosas
                    if (response.status === 404) {
                        throw new Error('No se encontró la persona con esa cédula.');
                    } else {
                        throw new Error('Error al procesar la solicitud.');
                    }
                }
                return response.json();
            })
            .then(data => {
                if (data.nombre) {
                    document.getElementById('floatingInputNombreConductor').value = toTitleCase(data.nombre); // Actualiza el campo del nombre
                    document.getElementById('errorCedula').textContent = ''; // Limpia el mensaje de error
                }        
                    if (data.cargo) {
                        document.getElementById('floatingInputCargoConductor').value = toTitleCase(data.cargo); // Actualiza el campo del cargo con formato
                        document.getElementById('errorCedula').textContent = ''; // Limpia el mensaje de error
                    }
                
                else if (data.error) {
                    document.getElementById('floatingInputNombreConductor').value = ''; // Limpia el campo del nombre
                    document.getElementById('floatingInputCargoConductor').value = '';
                    document.getElementById('errorCedula').textContent = data.error; // Muestra el mensaje de error desde la respuesta
                }
            })
            .catch(error => {
                // No mostramos mensajes de error en consola
                if (error.message === 'No se encontró el operador con esa cédula.') {
                    document.getElementById('errorCedula').textContent = error.message; // Muestra el mensaje específico
                } else {
                    document.getElementById('errorCedula').textContent = 'Ocurrió un error al procesar la solicitud. Intenta nuevamente.'; // Muestra mensaje genérico
                }
            });
        }
    });
    
    
    document.getElementById('floatingInputCedulaAcompanante').addEventListener('blur', function () {
        const cedula = this.value.trim(); // Obtener el valor del input y limpiarlo
        
        if (cedula) {
            fetch('/registros/buscarAcompanante?cedula_acompanante=' + cedula, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                credentials: 'same-origin' 
            })
            .then(response => {
                if (!response.ok) {
                    // Manejar respuestas que no son exitosas
                    if (response.status === 404) {
                        throw new Error('No se encontró el acompañante con esa cédula.');
                    } else {
                        throw new Error('Error al procesar la solicitud.');
                    }
                }
                return response.json();
            })
            .then(data => {
                if (data.nombre) {
                    document.getElementById('floatingInputNombreAcompanante').value = toTitleCase(data.nombre); // Actualiza el campo del nombre con formato
                    document.getElementById('errorCedula').textContent = ''; // Limpia el mensaje de error
                    if (data.cargo) {
                        document.getElementById('floatingInputCargoAcompanante').value = toTitleCase(data.cargo); // Actualiza el campo del cargo con formato
                        document.getElementById('errorCedula').textContent = ''; // Limpia el mensaje de error
                    }
                } else if (data.error) {
                    document.getElementById('floatingInputNombreAcompanante').value = ''; // Limpia el campo del nombre
                    document.getElementById('floatingInputCargoAcompanante').value = '';
                    document.getElementById('errorCedula').textContent = data.error; // Muestra el mensaje de error desde la respuesta
                }
            })
            .catch(error => {
                if (error.message === 'No se encontró la persona con esa cédula.') {
                    document.getElementById('errorCedula').textContent = error.message; // Muestra el mensaje específico
                } else {
                    document.getElementById('errorCedula').textContent = 'Ocurrió un error al procesar la solicitud. Intenta nuevamente.'; // Muestra mensaje genérico
                }
            });
        }
    });
    
    function toTitleCase(text) {
        return text
            .toLowerCase() // Convierte todo a minúsculas
            .split(' ') // Divide en palabras
            .map(word => word.charAt(0).toUpperCase() + word.slice(1)) // Primera letra mayúscula, el resto minúsculas
            .join(' '); // Une las palabras de nuevo
    }


    document.addEventListener('DOMContentLoaded', function () {
        const input = document.getElementById('floatingInputKilometrajeSalida');
    
        input.addEventListener('input', function () {
            let valor = input.value.replace(/\D/g, ''); // quitar todo lo que no sea dígito
            if (valor) {
                input.value = parseInt(valor).toLocaleString('es');
            } else {
                input.value = '';
            }
        });
    
        // Quitar formato antes de enviar el formulario
        input.form.addEventListener('submit', function () {
            input.value = input.value.replace(/\./g, '');
        });
    });

    function previewFile(input, previewId, removeBtnId) {
        const file = input.files[0];
        const preview = document.getElementById(previewId);
        const removeBtn = document.getElementById(removeBtnId);
        const icon = input.closest('.image-upload-box').querySelector('.add-icon');
      
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            preview.src = e.target.result;
            preview.style.display = 'block';
            icon.style.display = 'none';
            removeBtn.style.display = 'inline-block';
          };
          reader.readAsDataURL(file);
        }
      }
      
      function removeImage(event, inputId, previewId, removeBtnId) {
        event.stopPropagation(); // Previene que se dispare el click del input
        const input = document.getElementById(inputId);
        const preview = document.getElementById(previewId);
        const removeBtn = document.getElementById(removeBtnId);
        const icon = input.closest('.image-upload-box').querySelector('.add-icon');
      
        input.value = '';
        preview.src = '';
        preview.style.display = 'none';
        removeBtn.style.display = 'none';
        icon.style.display = 'block';
      }

</script>

{% include "inc/footer.html" %}